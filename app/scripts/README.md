# 画像＆ボディラインペア生成スクリプト

このディレクトリには、Dartを使用してランダムにプロンプトを生成し、image_serviceとbodyline_serviceを使用して画像とbodylineのペアを生成するスクリプトが含まれています。

## 機能

- ランダムなプロンプトの自動生成
- Dartを使用したタグの自動生成と重み付け
- Stable Diffusionによる画像生成
- ControlNetを使用したボディライン抽出
- 生成された画像、ボディライン、メタデータの自動保存
- 連番による画像管理（8桁の0埋め）
- 開始番号の指定機能
- 生成数の指定機能

### 画像サイズプリセット

以下のアスペクト比のプリセットからランダムに選択されます：

- 1:1 (1024×1024)
- 1.29:1 (1152×896)
- 1:1.29 (896×1152)
- 1:1.46 (832×1216)
- 1.46:1 (1216×832)
- 1.75:1 (1344×768)
- 1:1.75 (768×1344)
- 2.4:1 (1536×640)
- 1:2.4 (640×1536)

## 使い方

### 前提条件

- Python 3.9以上
- 必要なライブラリがインストールされていること（requirements.txtを参照）
- GPUメモリが十分にあること（最低12GB以上推奨）

### スクリプトの実行

基本的な実行方法：

```bash
# プロジェクトのルートディレクトリから実行することが重要です
cd プロジェクトルートディレクトリ
python -m app.scripts.generate_infinite_pairs --output OUTPUT_DIR [--count COUNT] [--start START]
```

#### 実行時の注意点

1. スクリプトは必ずプロジェクトのルートディレクトリから実行してください
2. 以下のようなディレクトリ構造になっていることを確認してください：

```
プロジェクトルート/
├── app/
│   ├── core/
│   ├── services/
│   └── scripts/
│       └── generate_infinite_pairs.py
└── requirements.txt
```

3. 環境変数やモデルファイルが正しく設定されていることを確認してください

#### コマンドライン引数

- `--output`, `-o` (必須): 出力先ディレクトリのパス
- `--count`, `-c` (オプション): 生成する画像の数（デフォルト: 1）
- `--start`, `-s` (オプション): 開始番号（デフォルト: 0）

#### 実行例

1. 基本的な使用方法（1枚生成）:
```bash
python -m app.scripts.generate_infinite_pairs -o ./output
```

2. 指定した数の画像を生成:
```bash
python -m app.scripts.generate_infinite_pairs -o ./output -c 10
```

3. 開始番号を指定して生成:
```bash
python -m app.scripts.generate_infinite_pairs -o ./output -c 30 -s 105
```
この場合、105から134までの番号で画像が生成されます。

### 出力ディレクトリ構造

指定した出力ディレクトリの下に以下のサブディレクトリが作成されます：

```
OUTPUT_DIR/
├── image/          # 生成された画像ファイル
│   ├── 00000000.png
│   ├── 00000001.png
│   └── ...
├── bodyline/       # 生成されたボディラインファイル
│   ├── 00000000.png
│   ├── 00000001.png
│   └── ...
└── metadata/       # メタデータJSONファイル
    ├── 00000000.json
    ├── 00000001.json
    └── ...
```

### メタデータフォーマット

各生成ペアのメタデータは以下の形式のJSONファイルとして保存されます：

```json
{
  "id": 0,                    # 画像の連番ID
  "prompt": "プロンプト",
  "tags": ["タグのリスト"],
  "image_path": "画像のパス",
  "bodyline_path": "ボディラインのパス",
  "image_params": {
    "画像生成に使用されたパラメータ"
  },
  "bodyline_params": {
    "ボディライン生成に使用されたパラメータ"
  }
}
```

## 注意事項

- このスクリプトは大量のGPUメモリを使用します
- 長時間の実行により、ディスク容量を圧迫する可能性があります
- ランダム生成のため、得られる結果の品質にはばらつきがあります
- 既存のファイルは上書きされるため、開始番号の指定には注意が必要です 